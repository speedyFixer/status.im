<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#"><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <title>Status</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Canonical links -->
  <link rel="canonical" href="https://dev.status.im/research/pfs.html">
  <!-- Alternative links -->
  
    
      <link rel="alternative" hreflang="en" href="https://dev.status.im/research/pfs.html">
    
      <link rel="alternative" hreflang="es" href="https://dev.status.im/es/research/pfs.html">
    
      <link rel="alternative" hreflang="ko" href="https://dev.status.im/ko/research/pfs.html">
    
  
  <!-- Icon -->
  <link rel="icon" type="image/png" href="/img/logo-16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/img/logo-32.png" sizes="32x32">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon-76.png?v=0.0.5">
  <link rel="apple-touch-icon" sizes="120x120" href="/img/apple-touch-icon-120.png?v=0.0.5">
  <link rel="apple-touch-icon" sizes="152x152" href="/img/apple-touch-icon-152.png?v=0.0.5">
  <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon-180.png?v=0.0.5">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon-1024.png?v=0.0.5">
  <link rel="stylesheet" href="/css/main.min.css">
  <link rel="alternate" href="/atom.xml" title="Status">
  <meta property="og:image" content="/img/share.png">
  <meta property="og:title" content="Status, a Mobile Client for Ethereum 2.0">
</head>

<body>
  <div id="container">
    
      <div class="header">
    <div class="header-left">
        <a class="logo" href="/"></a>
        
<ul class="main-nav">
    <li class="item--to-show"><a href="https://status.im/get" class="">App</a></li>
    <li class="item--to-show"> <a href="https://our.status.im/">Blog</a> </li>
    <li class="item--to-show"> <a href="https://status.im/docs">Docs</a></li>
    <li class="item--dropdown item--dropdown-projects"> <a href="#" class="">Projects</a></li>
    <li><a href="https://status.im/contribute">Contribute</a></li>
    <li class="item--dropdown"><a href="#" class="item--dropdown-community">Community</a></li>
    <li class="item--more"><a href="#" class="item--more">More</a></li>
</ul>

    </div>
    <div class="header-right">
        <a href="https://get.status.im/chat/public/status" class="button">Join Status Chat</a>
    </div>
</div>

<div class="mobile-nav-wrap">
    <div class="mobile-nav-inner">
        <a class="logo" href="/"></a>
        <a class="icon-close mobile-nav-close" href="#"></a>
        <ul class="mobile-nav">
            <li><a href="https://our.status.im/">Blog</a></li>
            <li><a href="/docs">Docs</a></li>
            <li class="item--dropdown item--to-show">
              <span>Projects</span>
              <ul class="mobile-sub-nav">
                <li><a href="https://incubate.status.im/" class="">Incubate</a></li>
                <li><a href="https://nimbus.status.im/" class="">Nimbus</a></li>
                <li><a href="https://embark.status.im/" class="">Embark</a></li>
                <li><a href="https://hardwallet.status.im/" class="">Keycard</a></li>
              </ul>
            </li>
            <li><a href="/contribute" class="">Contribute</a></li>
        </ul>
        <div class="mobile-nav-footer">
            <a href="https://get.status.im/chat/public/status" class="button button--blue">Join Status Chat</a>
        </div>
    </div>
    <div class="mobile-nav-overlay"></div>
</div>

<div class="popup-wrap popup-wrap--community">
    <div class="popup popup--community">
        <a class="popup__button popup__button--close"></a>
        <h3 class="popup__title">Community</h3>
        <div class="popup__inner">
            <div class="cards cards--three cards--three--even cards--community cards--community--light">
                <div class="card">
                    <a href="https://get.status.im/chat/public/status" class="card-inner">
                        <div class="community-icon community-icon--join"></div>
                        <h4>Join the chat in Status</h4>
                        <p class="secondary-text">Whisper sweet, encrypted nothings on a distributed network that no-one owns.</p>
                    </a>
                </div>
                <div class="card">
                    <a href="https://discuss.status.im/" class="card-inner">
                        <div class="community-icon community-icon--discussion"></div>
                        <h4>Join the Discussion</h4>
                        <p class="secondary-text">Join longer discussions, work in progress, and our research here.</p>
                    </a>
                </div>
                <div class="card">
                    <a href="https://github.com/status-im/" class="card-inner">
                        <div class="community-icon community-icon--contrubute"></div>
                        <h4>Contribute to our Repos</h4>
                        <p class="secondary-text">Help us #buidl the future by getting involved in the most active code base in Ethereum.</p>
                    </a>
                </div>
            </div>
            <h5>Find Out More</h5>
            <div class="cards cards-community-more cards--three cards--three--even">
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <div class="latest-posts latest-news"></div>
                        </div>
                        <div class="card-community-more__link"><a href="https://our.status.im/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Life at Status</h4>
                            <p class="secondary-text">What's it like to live the decentralized lifestyle? Find out here.</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://status.im/contribute/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Follow us on Twitter</h4>
                            <p class="secondary-text">Join the conversation on our social channels to learn more.</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://twitter.com/ethstatus/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="popup-overlay"></div>
</div>

<div class="popup-wrap popup-wrap--projects">
    <div class="popup popup--projects">
        <a class="popup__button popup__button--close"></a>
        <h3 class="popup__title">Projects</h3>
        <div class="popup__inner">
            <h5>Help us #buidl</h5>
            <div class="cards cards-community-more cards--three cards--three--even">
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Embark</h4>
                            <p class="secondary-text">Embark is a simple and easy to use development framework that enables you to build and deploy your own decentralized applications smoothly.</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://embark.status.im/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Nimbus</h4>
                            <p class="secondary-text">A research project and light client for Ethereum 2.0 designed to perform well on embedded systems and resource-restricted hardware.</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://nimbus.status.im" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Keycard</h4>
                            <p class="secondary-text">A hardware wallet in the form of a card with a safe, contactless transaction experience</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://hardwallet.status.im/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
            </div>
            <div class="separator"></div>
            <h5>Enable Everyone</h5>
            <div class="cards cards-community-more cards--three cards--three--even">
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Incubate</h4>
                            <p class="secondary-text">Incubate supports open source, early stage startups with funding, technical mentorship, legal and regulatory compliance and much more.</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://incubate.status.im/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Statusphere</h4>
                            <p class="secondary-text">Get involved in our community today, no matter who you are.</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://status.im/statusphere/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="popup-overlay"></div>
</div>

    
    <div class="page-intro wrapper">
<div class="search">
    <input type="text" name="userSearch" id="userSearch" placeholder="Search...">
    <script src="/js/jquery-3.3.1.min.js"></script>
    <script src="/js/jquery.marcopolo.min.js" type="text/javascript"></script>
    <script type="text/javascript" defer>
    $('#userSearch').marcoPolo({
        url: 'https://search.status.im/' + window.location.host + '/_search?size=5&_source=title,url&',
        minChars: 3,
        formatItem: function (data, $item) {
        return data.title || data.url;
        },
        formatData: function (data) {
        return data.hits.hits.map(function(obj) {
            return obj._source;
        });
        },
        onSelect: function (data, $item) {
        window.location = data.url;
        }
    });
    </script>
</div>
<div class="clear"></div>

  <header class="article-header">
    <h1 class="article-title" itemprop="name"></h1>
    <a href="https://github.com/status-im/docs.status.im/edit/develop/source/research/pfs.md" class="article-edit-link" title="Improve this doc">Edit on Github</a>
  </header>
</div>
<div id="content-wrap">
  <div id="content" class="wrapper">
    <div id="content-inner">
      <aside id="sidebar" role="navigation">
  <div class="inner">
    <strong class="sidebar-title">Whisper</strong><a href="index.html" class="sidebar-link">Do You Want To Know A Secret?</a><a href="extended_features.html" class="sidebar-link">Extended Features</a><a href="dark_routing.html" class="sidebar-link">Dark Routing</a><a href="whisper_pss.html" class="sidebar-link">Comparison with PSS</a><a href="whisper_faqs.html" class="sidebar-link">Whisper FAQs</a><a href="secure_messaging_compendium.html" class="sidebar-link">Secure Messaging Compendium</a><a href="https://our.status.im/tag/research" class="sidebar-link">Research Blog</a><strong class="sidebar-title">Research Projects</strong><a href="pfs.html" class="sidebar-link current">Perfect Forward Secrecy</a><a href="ulc_in_details.html" class="sidebar-link">Ultra Light Clients</a><a href="https://nimbus.status.im/" class="sidebar-link">Nimbus</a><strong class="sidebar-title">Tutorials</strong><a href="../tutorials/whisper_basic_cli.html" class="sidebar-link">Whisper in Your CLI</a><a href="../tutorials/whisper_embark.html" class="sidebar-link">Whisper with Embark</a>
  </div>
</aside>
      <article class="article-container" itemscope="" itemtype="http://schema.org/Article">
        <div class="article-inner">
          <div class="article">
            <div class="inner">
              <div class="article-content" itemprop="articleBody">
                <h1 id="Status-Perfect-Forward-Secrecy-Whitepaper" class="article-heading"><a href="#Status-Perfect-Forward-Secrecy-Whitepaper" class="headerlink" title="Status Perfect Forward Secrecy Whitepaper"></a>Status Perfect Forward Secrecy Whitepaper<a class="article-anchor" href="#Status-Perfect-Forward-Secrecy-Whitepaper" aria-hidden="true"></a></h1><p>[TOC]</p>
<h2 id="1-Introduction" class="article-heading"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction<a class="article-anchor" href="#1-Introduction" aria-hidden="true"></a></h2><p>This whitepaper describes the protocols used by Status to achieve Perfect Forward Secrecy for 1:1 chat participants. It builds on the <a href="https://signal.org/docs/specifications/x3dh/" target="_blank" rel="noopener">X3DH</a> and <a href="https://signal.org/docs/specifications/doubleratchet/" target="_blank" rel="noopener">Double Ratchet</a> specifications from Open Whisper Systems, with some adaptations to operate in a decentralized environment.</p>
<h3 id="1-1-Definitions" class="article-heading"><a href="#1-1-Definitions" class="headerlink" title="1.1. Definitions"></a>1.1. Definitions<a class="article-anchor" href="#1-1-Definitions" aria-hidden="true"></a></h3><ul>
<li><p><strong>Perfect Forward Secrecy</strong> is a feature of specific key-agreement protocols which provide assurances that your session keys will not be compromised even if the private keys of the participants are compromised. Specifically, past messages cannot be decrypted by a third-party who manages to get a hold of a private key.</p>
</li>
<li><p><strong>Secret channel</strong> describes a communication channel where Double Ratchet algorithm is in use.</p>
</li>
</ul>
<h3 id="1-2-Design-Requirements" class="article-heading"><a href="#1-2-Design-Requirements" class="headerlink" title="1.2. Design Requirements"></a>1.2. Design Requirements<a class="article-anchor" href="#1-2-Design-Requirements" aria-hidden="true"></a></h3><ul>
<li><p><strong>Confidentiality</strong></p>
<p>The adversary should not be able to learn what data is being exchanged between two Status clients.</p>
</li>
<li><p><strong>Authenticity</strong></p>
<p>The adversary should not be able to cause either endpoint of a Status 1:1 chat to accept data from any third party as though it came from the other endpoint.</p>
</li>
<li><p><strong>Forward Secrecy</strong></p>
<p>The adversary should not be able to learn what data was exchanged between two Status clients if, at some later time, the adversary compromises one or both of the endpoint devices.</p>
</li>
</ul>
<h3 id="1-3-Conventions" class="article-heading"><a href="#1-3-Conventions" class="headerlink" title="1.3. Conventions"></a>1.3. Conventions<a class="article-anchor" href="#1-3-Conventions" aria-hidden="true"></a></h3><p>Types used in this specification are defined using <a href="https://developers.google.com/protocol-buffers/" target="_blank" rel="noopener">Protobuf</a>. Protocol buffers are a language-neutral, platform-neutral, extensible mechanism for serializing structured data.</p>
<h3 id="1-4-Transport-Layer" class="article-heading"><a href="#1-4-Transport-Layer" class="headerlink" title="1.4. Transport Layer"></a>1.4. Transport Layer<a class="article-anchor" href="#1-4-Transport-Layer" aria-hidden="true"></a></h3><p><a href="./index.html">Whisper</a> serves as the transport layer for the Status chat protocol. Whisper is a hybrid P2P/DHT communication protocol which delivers messages probabilistically. It is designed to provide configurable levels of darkness and plausible deniability at the expense of high-latency and relatively high bandwidth.</p>
<h3 id="1-5-User-flow-for-1-to-1-communications" class="article-heading"><a href="#1-5-User-flow-for-1-to-1-communications" class="headerlink" title="1.5. User flow for 1-to-1 communications"></a>1.5. User flow for 1-to-1 communications<a class="article-anchor" href="#1-5-User-flow-for-1-to-1-communications" aria-hidden="true"></a></h3><h4 id="1-5-1-Account-generation" class="article-heading"><a href="#1-5-1-Account-generation" class="headerlink" title="1.5.1. Account generation"></a>1.5.1. Account generation<a class="article-anchor" href="#1-5-1-Account-generation" aria-hidden="true"></a></h4><p>Generating a user account in Status involves 3 steps:</p>
<ul>
<li>Generation of a random seed, and the respective account;</li>
<li>Generation of a X3DH bundle. This prekey bundle will become part of the user’s contact code;</li>
<li>Registration with Push Notification platform.</li>
</ul>
<h4 id="1-5-2-Contact-request" class="article-heading"><a href="#1-5-2-Contact-request" class="headerlink" title="1.5.2. Contact request"></a>1.5.2. Contact request<a class="article-anchor" href="#1-5-2-Contact-request" aria-hidden="true"></a></h4><p>Once two accounts have been generated (Alice and Bob), Alice can send a contact request with an introductory message to Bob.</p>
<p>There are two possible scenarios, which dictate the presence or absence of a prekey bundle:</p>
<ol>
<li>If Alice is using Bob’s public chat key or ENS name, no prekey bundle is present;</li>
<li>If Alice found Bob through the app or scanned Bob’s QR code, a prekey bundle is embedded and can be used to set up a secure channel as described in section <a href="#241-Initial-key-exchange-flow-X3DH">2.4.1</a>.</li>
</ol>
<p>Bob receives a contact request, informing him of:</p>
<ul>
<li>the security level of the communication;</li>
<li>Alice’s introductory message.</li>
</ul>
<p>If Bob’s prekey bundle was not available to Alice, Perfect Forward Secrecy hasn’t yet been established. In any case, there are no implicit guarantees that Alice is whom she claims to be, and Bob should perform some form of external verification (e.g., using an Identicon).</p>
<p>If Bob accepts the contact request, a secure channel is created (if it wasn’t already), and a visual indicator is displayed to signify that PFS has been established. Bob and Alice can then start exchanging messages, making use of the Double Ratchet algorithm as explained in more detail in section <a href="#242-Double-Ratchet">2.4.2</a>.<br>If Bob denies the request, Alice is not able to send messages and the only action available is resending the contact request.</p>
<h4 id="1-5-3-Account-recovery" class="article-heading"><a href="#1-5-3-Account-recovery" class="headerlink" title="1.5.3. Account recovery"></a>1.5.3. Account recovery<a class="article-anchor" href="#1-5-3-Account-recovery" aria-hidden="true"></a></h4><p>If Alice later recovers her account, the Double Ratchet state information will not be available, so she is no longer able to decrypt any messages received from existing contacts.</p>
<p>If an incoming message (on the same Whisper topic) fails to decrypt, a message is shown to Alice asking whether she wants to re-establish a secure channel with Bob, repeating the procedure in the previous section. <strong><em>TODO: @cammellos for more detail, if any</em></strong></p>
<h2 id="2-Messaging" class="article-heading"><a href="#2-Messaging" class="headerlink" title="2. Messaging"></a>2. Messaging<a class="article-anchor" href="#2-Messaging" aria-hidden="true"></a></h2><p>All messaging in Status is subject to end-to-end encryption to provide users with a strong degree of privacy and security.</p>
<h3 id="2-1-End-to-end-encryption" class="article-heading"><a href="#2-1-End-to-end-encryption" class="headerlink" title="2.1. End-to-end encryption"></a>2.1. End-to-end encryption<a class="article-anchor" href="#2-1-End-to-end-encryption" aria-hidden="true"></a></h3><p>End-to-end encryption (E2EE) takes place between two clients. The main cryptographic protocol is a <a href="https://github.com/status-im/doubleratchet/" target="_blank" rel="noopener">Status implementation</a> of the Double Ratchet protocol, which is in turn derived from the <a href="https://otr.cypherpunks.ca/Protocol-v3-4.1.1.html" target="_blank" rel="noopener">Off-the-Record protocol</a>, using a different ratchet. The message payload is subsequently encrypted by the transport protocol - Whisper (see section <a href="#14-Transport-Layer">1.4</a>) -, using symmetric key encryption.<br>Furthermore, Status uses the concept of prekeys (through the use of <a href="https://signal.org/docs/specifications/x3dh/" target="_blank" rel="noopener">X3DH</a>) to allow the protocol to operate in an asynchronous environment. It is not necessary for two parties to be online at the same time to initiate an encrypted conversation.</p>
<p>Status uses the following cryptographic primitives:</p>
<ul>
<li>Whisper<ul>
<li>AES-256-GCM</li>
<li>KECCAK-256</li>
</ul>
</li>
<li>X3DH<ul>
<li>Elliptic curve Diffie-Hellman key exchange (secp256k1)</li>
<li>KECCAK-256</li>
<li>ECDSA</li>
<li>ECIES</li>
</ul>
</li>
<li><p>Double Ratchet</p>
<ul>
<li>HMAC-SHA-256 as MAC</li>
<li>Elliptic curve Diffie-Hellman key exchange (Curve25519)</li>
<li><p>AES-256-CTR with HMAC-SHA-256 and IV derived alongside an encryption key</p>
<p>Key derivation is done using HKDF.</p>
</li>
</ul>
</li>
</ul>
<h3 id="2-2-Prekeys" class="article-heading"><a href="#2-2-Prekeys" class="headerlink" title="2.2. Prekeys"></a>2.2. Prekeys<a class="article-anchor" href="#2-2-Prekeys" aria-hidden="true"></a></h3><p>Every client initially generates some key material which is stored locally:</p>
<ul>
<li>Identity keypair based on secp256k1 - $IK$;</li>
<li>A signed prekey based on secp256k1 - $SPK$;</li>
<li>A prekey signature - <i>Sig($IK$, Encode($SPK$))</i></li>
</ul>
<p>Prekey bundles are exchanged through QR codes, contact codes, 1:1 or public chat messages. <em>We will be updating this document with information about bundle exchange through <a href="https://ens.domains/" target="_blank" rel="noopener">ENS</a> and <a href="https://swarm-guide.readthedocs.io/en/latest/introduction.html" target="_blank" rel="noopener">Swarm</a> as work progresses and technologies become more usable.</em></p>
<h3 id="2-3-Bundle-retrieval" class="article-heading"><a href="#2-3-Bundle-retrieval" class="headerlink" title="2.3. Bundle retrieval"></a>2.3. Bundle retrieval<a class="article-anchor" href="#2-3-Bundle-retrieval" aria-hidden="true"></a></h3><p>X3DH works by having client apps create and make available a bundle of prekeys (the X3DH bundle) that can later be requested by other interlocutors when they wish to start a conversation with a given user.</p>
<p>In the X3DH specification, a shared server is typically used to store bundles and allow other users to download them upon request. Given Status’ goal of decentralization, Status chat clients cannot rely on the same type of infrastructure and must achieve the same result using other means. By growing order of convenience and security, the considered approaches are:</p>
<ul>
<li>contact codes;</li>
<li>public and one-to-one chats;</li>
<li>QR codes;</li>
<li>ENS record;</li>
<li>Decentralized permanent storage (e.g. Swarm, IPFS).</li>
</ul>
<p>Since bundles stored in QR codes or ENS records cannot be updated to delete already used keys, the approach taken is to make publicly available an initial generic bundle without one-time prekeys, and subsequently provide a second user-specific X3DH prekey bundle (TO BE IMPLEMENTED).</p>
<h3 id="2-4-1-1-chat-contact-request" class="article-heading"><a href="#2-4-1-1-chat-contact-request" class="headerlink" title="2.4. 1:1 chat contact request"></a>2.4. 1:1 chat contact request<a class="article-anchor" href="#2-4-1-1-chat-contact-request" aria-hidden="true"></a></h3><p>There are two phases in the initial negotiation of a 1:1 chat:</p>
<ol>
<li><strong>Identity verification</strong> (e.g., face-to-face contact exchange through QR code, Identicon matching). A QR code serves two purposes simultaneously - identity verification and initial bundle retrieval;</li>
<li><strong>Asynchronous initial key exchange</strong>, using X3DH.</li>
</ol>
<h4 id="2-4-1-Initial-key-exchange-flow-X3DH" class="article-heading"><a href="#2-4-1-Initial-key-exchange-flow-X3DH" class="headerlink" title="2.4.1. Initial key exchange flow (X3DH)"></a>2.4.1. Initial key exchange flow (X3DH)<a class="article-anchor" href="#2-4-1-Initial-key-exchange-flow-X3DH" aria-hidden="true"></a></h4><p>The initial key exchange flow is described in <a href="https://signal.org/docs/specifications/x3dh/#sending-the-initial-message" target="_blank" rel="noopener">section 3 of the X3DH protocol</a>, with some additional context:</p>
<ul>
<li>The users’ identity keys $IK_A$ and $IK_B$ correspond to their respective Status chat public keys;</li>
<li>Since it is not possible to guarantee that a prekey will be used only once in a decentralized world, the one-time prekey $OPK_B$ is not used in this scenario;</li>
<li>Bundles are not sent to a centralized server, but instead served in a decentralized way as described in <a href="#23-Bundle-retrieval">section 2.3</a>.</li>
</ul>
<p>Bob’s prekey bundle is retrieved by Alice, however it is not specific to Alice. It contains:</p>
<p>(<a href="https://github.com/status-im/status-go/blob/c86f8bf6ca35280e7041674f76a2ef1fe333e482/services/shhext/chat/encryption.proto#L11" target="_blank" rel="noopener">protobuf</a>)</p>
<pre><code class="protobuf">message Bundle {
  bytes identity = 1;

  map&lt;string,SignedPreKey&gt; signed_pre_keys = 2;

  bytes signature = 4;
}
</code></pre>
<ul>
<li><code>identity</code>: Identity key $IK_B$</li>
<li><code>signed_pre_keys</code>: Signed prekey $SPK_B$ for each device, indexed by <code>installation-id</code></li>
<li><code>signature</code>: Prekey signature <i>Sig($IK_B$, Encode($SPK_B$))</i></li>
</ul>
<p>(<a href="https://github.com/status-im/status-go/blob/c86f8bf6ca35280e7041674f76a2ef1fe333e482/services/shhext/chat/encryption.proto#L5" target="_blank" rel="noopener">protobuf</a>)</p>
<pre><code class="protobuf">message SignedPreKey {
  bytes signed_pre_key = 1;
  uint32 version = 2;
}
</code></pre>
<p>The <code>signature</code> is generated by sorting <code>installation-id</code> in lexicographical order, and concatenating the <code>signed-pre-key</code> and <code>version</code>:</p>
<p><code>installation-id-1signed-pre-key1version1installation-id2signed-pre-key2-version-2</code></p>
<h4 id="2-4-2-Double-Ratchet" class="article-heading"><a href="#2-4-2-Double-Ratchet" class="headerlink" title="2.4.2. Double Ratchet"></a>2.4.2. Double Ratchet<a class="article-anchor" href="#2-4-2-Double-Ratchet" aria-hidden="true"></a></h4><p>Having established the initial shared secret <code>SK</code> through X3DH, we can use it to seed a Double Ratchet exchange between Alice and Bob.</p>
<p>Please refer to the <a href="https://signal.org/docs/specifications/doubleratchet/" target="_blank" rel="noopener">Double Ratchet spec</a> for more details.</p>
<p>The initial message sent by Alice to Bob is sent as a top-level <code>ProtocolMessage</code> (<a href="https://github.com/status-im/status-go/blob/1ac9dd974415c3f6dee95145b6644aeadf02f02c/services/shhext/chat/encryption.proto#L64" target="_blank" rel="noopener">protobuf</a>) containing a map of <code>DirectMessageProtocol</code> indexed by <code>installation-id</code> (<a href="https://github.com/status-im/status-go/blob/1ac9dd974415c3f6dee95145b6644aeadf02f02c/services/shhext/chat/encryption.proto#L56" target="_blank" rel="noopener">protobuf</a>):</p>
<pre><code class="protobuf">message ProtocolMessage {
  Bundle bundle = 1;

  map&lt;string,DirectMessageProtocol&gt; direct_message = 101;

  bytes public_message = 102;
}
</code></pre>
<ul>
<li><code>bundle</code>: optional bundle is exchanged with each message;</li>
<li><code>direct_message</code> is a map of <code>DirectMessageProtocol</code> indexed by <code>installation-id</code></li>
<li><code>public_message</code>: unencrypted public chat message.</li>
</ul>
<pre><code class="protobuf">message DirectMessageProtocol {
  X3DHHeader X3DH_header = 1;
  DRHeader DR_header = 2;
  DHHeader DH_header = 101;
  // Encrypted payload
  bytes payload = 3;
}
</code></pre>
<ul>
<li><p><code>X3DH_header</code>: the <code>X3DHHeader</code> field in <code>DirectMessageProtocol</code> contains:</p>
<p>  (<a href="https://github.com/status-im/status-go/blob/features%2Fx3dh/services/shhext/chat/encryption.proto#L27" target="_blank" rel="noopener">protobuf</a>)</p>
<pre><code class="protobuf">  message X3DHHeader {
    bytes key = 1;
    bytes id = 4;
  }
</code></pre>
<ul>
<li><code>key</code>: Alice’s ephemeral key $EK_A$;</li>
<li><p><code>id</code>: Identifier stating which of Bob’s prekeys Alice used, in this case Bob’s bundle signed prekey.</p>
<p>Alice’s identity key $IK_A$ is sent at the transport layer level (Whisper);</p>
</li>
</ul>
</li>
<li><p><code>DR_header</code>: Double ratchet header (<a href="https://github.com/status-im/status-go/blob/features%2Fx3dh/services/shhext/chat/encryption.proto#L16" target="_blank" rel="noopener">protobuf</a>). Used when Bob’s public bundle is available:</p>
<pre><code class="protobuf">  message DRHeader {
    bytes key = 1;
    uint32 n = 2;
    uint32 pn = 3;
    bytes id = 4;
  }
</code></pre>
<ul>
<li><code>key</code>: Alice’s current ratchet public key (as mentioned in <a href="https://signal.org/docs/specifications/doubleratchet/#symmetric-key-ratchet" target="_blank" rel="noopener">DR spec section 2.2</a>);</li>
<li><code>n</code>: number of the message in the sending chain;</li>
<li><code>pn</code>: length of the previous sending chain;</li>
<li><code>id</code>: Bob’s bundle ID.</li>
</ul>
</li>
<li><p><code>DH_header</code>: Diffie-Helman header (used when Bob’s bundle is not available):<br>  (<a href="https://github.com/status-im/status-go/blob/features%2Fx3dh/services/shhext/chat/encryption.proto#L23" target="_blank" rel="noopener">protobuf</a>)</p>
<pre><code class="protobuf">  message DHHeader {
    bytes key = 1;
  }
</code></pre>
<ul>
<li><code>key</code>: Alice’s compressed ephemeral public key.</li>
</ul>
</li>
<li><p><code>payload</code>:</p>
<ul>
<li>if a bundle is available, contains payload encrypted with the Double Ratchet algorithm;</li>
<li>otherwise, payload encrypted with output key of DH exchange (no Perfect Forward Secrecy).<br>-</li>
</ul>
</li>
</ul>
<h1 id="3-Session-Management" class="article-heading"><a href="#3-Session-Management" class="headerlink" title="3. Session Management"></a>3. Session Management<a class="article-anchor" href="#3-Session-Management" aria-hidden="true"></a></h1><p>This section describe how sessions are handled.</p>
<p>A peer is identified by two pieces of data:</p>
<p>1) An <code>installation-id</code> which is generated upon creating a new account in the <code>Status</code> application<br>2) Their identity whisper key</p>
<h2 id="3-1-Initializiation" class="article-heading"><a href="#3-1-Initializiation" class="headerlink" title="3.1 Initializiation"></a>3.1 Initializiation<a class="article-anchor" href="#3-1-Initializiation" aria-hidden="true"></a></h2><p>A new session is initialized once a successful X3DH exchange has taken place.<br>Subsequent messages will use the established session until re-keying is necessary.</p>
<h2 id="3-2-Concurrent-sessions" class="article-heading"><a href="#3-2-Concurrent-sessions" class="headerlink" title="3.2 Concurrent sessions"></a>3.2 Concurrent sessions<a class="article-anchor" href="#3-2-Concurrent-sessions" aria-hidden="true"></a></h2><p>If two sessions are created concurrently between two peers the one with the symmetric key first in byte order should be used, marking the other has expired (TO BE IMPLEMENTED).</p>
<h2 id="3-3-Re-keying" class="article-heading"><a href="#3-3-Re-keying" class="headerlink" title="3.3 Re-keying"></a>3.3 Re-keying<a class="article-anchor" href="#3-3-Re-keying" aria-hidden="true"></a></h2><p>On receiving a bundle from a given peer with a higher version, the old bundle should be marked as expired and a new session should be established on the next message sent.</p>
<h2 id="3-4-Expired-session" class="article-heading"><a href="#3-4-Expired-session" class="headerlink" title="3.4 Expired session"></a>3.4 Expired session<a class="article-anchor" href="#3-4-Expired-session" aria-hidden="true"></a></h2><p>Expired session should not be used for new messages and should be deleted after 14 days from the expiration date (TO BE IMPLEMENTED), in order to be able to decrypt out-of-order and mailserver messages.</p>
<h2 id="4-Multi-device-support" class="article-heading"><a href="#4-Multi-device-support" class="headerlink" title="4. Multi-device support"></a>4. Multi-device support<a class="article-anchor" href="#4-Multi-device-support" aria-hidden="true"></a></h2><p>Multi-device support is quite challenging as we don’t have a central place where information on which and how many devices (identified by their respective <code>installation-id</code>) belongs to a whisper-identity.</p>
<p>Furthermore we always need to take account recovery in consideration, where the whole device is wiped clean and all the information about any previous sessions is lost.</p>
<p>Taking these considerations into account, the way multi-device information is propagated through the network is through bundles/contact codes, which will contain information about paired devices as well as information about the sending device.</p>
<p>This mean that every time a new device is paired, the bundle needs to be updated and propagated with the new information, and the burden is put on the user to make sure the pairing is successful.</p>
<h2 id="4-1-Pairing" class="article-heading"><a href="#4-1-Pairing" class="headerlink" title="4.1 Pairing"></a>4.1 Pairing<a class="article-anchor" href="#4-1-Pairing" aria-hidden="true"></a></h2><p>When a user adds a new account, a new <code>installation-id</code> will be generated. The device should be paired as soon as possible if other devices are present. Once paired the contacts will be notified of the new device and it will be included in further communications.</p>
<p>Any time a bundle from your $IK$ but different <code>installation-id</code> is received, the device is added to the pairing group. From now on any message sent by one device will also be sent to any device in the pairing group. Eventually devices will have to be explicitly confirmed by the user <em>(TO BE IMPLEMENTED)</em>.</p>
<p>Upon receiving a new bundle from it’s own <code>$IK$</code> the following operation are performed:</p>
<p>1) For each signed-pre-key if the local version is &lt; then the one received or is missing, the local version will be updated/added.<br>2) If the received bundle is missing the receiving installation-id, the bundle will be updated with the receiving installation-id and current signed-pre-key/version. </p>
<p>After this step a new contact-code/bundle will be generated which will include pairing information.</p>
<p>The bundle will be propagated to contacts through contact updates. The user will be notified to update their contact-code in any other place where it might be stored. (TO BE IMPLEMENTED).</p>
<p>Removal of paired devices is a manual step that needs to be applied on each device (TO BE IMPLEMENTED).</p>
<h2 id="4-2-Sending-messages-to-a-paired-group" class="article-heading"><a href="#4-2-Sending-messages-to-a-paired-group" class="headerlink" title="4.2 Sending messages to a paired group"></a>4.2 Sending messages to a paired group<a class="article-anchor" href="#4-2-Sending-messages-to-a-paired-group" aria-hidden="true"></a></h2><p>When sending a message, the peer will send a message to any <code>installation-id</code> that they have seen, using pairwise encryption, including their own devices.</p>
<p>The number of devices will be capped to a reasonable number,  ordered by last activity. (5, 10? TO BE IMPLEMENTED)</p>
<h2 id="4-3-Stale-devices-TO-BE-IMPLEMENTED" class="article-heading"><a href="#4-3-Stale-devices-TO-BE-IMPLEMENTED" class="headerlink" title="4.3 Stale devices (TO BE IMPLEMENTED)"></a>4.3 Stale devices (TO BE IMPLEMENTED)<a class="article-anchor" href="#4-3-Stale-devices-TO-BE-IMPLEMENTED" aria-hidden="true"></a></h2><p>When a bundle is received from $IK$ a timer is initiated on any <code>installation-id</code> belonging to $IK$ not included in the bundle. If after 7 days no bundles are received from these devices they are marked as <code>stale</code> and no message will be sent to them.</p>
<h2 id="4-4-Account-recovery" class="article-heading"><a href="#4-4-Account-recovery" class="headerlink" title="4.4 Account recovery"></a>4.4 Account recovery<a class="article-anchor" href="#4-4-Account-recovery" aria-hidden="true"></a></h2><p>Account recovery is no different from adding a new device, and it is handled in exactly the same way.</p>
<h2 id="4-5-Partitioned-devices-TO-BE-IMPLEMENTED" class="article-heading"><a href="#4-5-Partitioned-devices-TO-BE-IMPLEMENTED" class="headerlink" title="4.5 Partitioned devices (TO BE IMPLEMENTED)"></a>4.5 Partitioned devices (TO BE IMPLEMENTED)<a class="article-anchor" href="#4-5-Partitioned-devices-TO-BE-IMPLEMENTED" aria-hidden="true"></a></h2><p>In some cases (i.e. account recovery when no other pairing device is available, device not paired), it is possible that a device will receive a message that is not targeted to its own <code>installation-id</code>.<br>In this case the user will be presented with a prompt, notifying them that $IK$ has sent them a message, and an option will be given to send a bundle back so that further communication<br>can happen.</p>
<h1 id="4-Security-Considerations" class="article-heading"><a href="#4-Security-Considerations" class="headerlink" title="4. Security Considerations"></a>4. Security Considerations<a class="article-anchor" href="#4-Security-Considerations" aria-hidden="true"></a></h1><p>The same considerations apply as in <a href="https://signal.org/docs/specifications/x3dh/#security-considerations" target="_blank" rel="noopener">section 4 of the X3DH spec</a> and <a href="https://signal.org/docs/specifications/doubleratchet/#security-considerations" target="_blank" rel="noopener">section 6 of the Double Ratchet spec</a>, with some additions detailed below.</p>
<p><strong><em>TODO: Add any additional context here not covered in the X3DH and DR specs, e.g.:</em></strong></p>

              </div>
              <footer class="article-footer">
                <time class="article-footer-updated" datetime="2018-12-18T03:39:13.080Z" itemprop="dateModified">Last updated: 2018-12-18</time>
                <a href="https://our.status.im/tag/research" class="article-footer-prev" title="Research Blog"><i class="fa fa-chevron-left"></i><span>Prev</span></a><a href="ulc_in_details.html" class="article-footer-next" title="Ultra Light Clients"><span>Next</span><i class="fa fa-chevron-right"></i></a>
              </footer>
            </div>
          </div>
        </div>
      </article>
    </div>
  </div>
</div>

    
      
<div class="footer footer--global">
    <div class="footer-inner">
        <div class="footer-table">
            <div class="footer-table__column">
                <p class="footer-header">Social links</p>
                <ul class="footer-list">
                    <li class="footer-link footer-link--fb"><a href="https://www.facebook.com/ethstatus" target="_blank"><span class="footer-icon"></span><span class="footer-link-label">Facebook</span></a></li>
                    <li class="footer-link footer-link--tw"><a href="https://twitter.com/ethstatus" target="_blank"><span class="footer-icon"></span><span class="footer-link-label">Twitter</span></a></li>
                    <li class="footer-link footer-link--ri"><a href="https://chat.status.im/#/register" target="_blank"><span class="footer-icon"></span><span class="footer-link-label">Riot</span></a></li>
                    <li class="footer-link footer-link--gh"><a href="https://github.com/status-im" target="_blank"><span class="footer-icon"></span><span class="footer-link-label">Github</span></a></li>
                    <li class="footer-link footer-link--rd"><a href="https://www.reddit.com/r/statusim/" target="_blank"><span class="footer-icon"></span><span class="footer-link-label">Reddit</span></a></li>
                    <li class="footer-link footer-link--yt"><a href="https://www.youtube.com/statusim" target="_blank"><span class="footer-icon"></span><span class="footer-link-label">YouTube</span></a></li>
                </ul>
            </div>

            <div class="footer-table__column">
                <p class="footer-header">More</p>
                <ul class="footer-list">
                    <li class="footer-link"><a href="https://status.im/docs/" target="_blank">Status Docs</a></li>
                    <li class="footer-link"><a href="https://our.status.im/" target="_blank">Status Blog</a></li>
                    <li class="footer-link"><a href="https://status.im/contribute/" target="_blank">Jobs</a></li>
                    <li class="footer-link"><a href="https://status.im/privacy-policy.html" target="_blank">Privacy Policy</a></li>
                </ul>
            </div>

            <div class="footer-table__column">
                <p class="footer-header">Projects</p>
                <ul class="footer-list">
                    <li class="footer-link"><a href="https://embark.status.im" target="_blank">Embark</a></li>
                    <li class="footer-link"><a href="https://hardwallet.status.im/" target="_blank">Keycard</a></li>
                    <li class="footer-link"><a href="https://incubate.status.im/" target="_blank">Incubate</a></li>
                    <li class="footer-link"><a href="https://nimbus.status.im/" target="_blank">Nimbus</a></li>
                </ul>
            </div>
        </div>
    
        <div class="footer-logo-wrap">
            <div class="footer-logo-wrap__inner">
                <a class="footer-logo" href="https://status.im" target="_blank"></a>
                <div class="footer-address secondary-text">Status Research & Development GmbH<br>Baarerstrasse 10<br>Zug, Switzerland</div>
            </div>
        </div>
    </div>
</div>

    
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>	
<script src="/js/vendor.min.js"></script>
</body>
</html>
