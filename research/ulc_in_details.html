<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#"><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <title>Ultra Light Client in details | Status</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Canonical links -->
  <link rel="canonical" href="https://dev.status.im/research/ulc_in_details.html">
  <!-- Alternative links -->
  
    
      <link rel="alternative" hreflang="en" href="https://dev.status.im/research/ulc_in_details.html">
    
      <link rel="alternative" hreflang="es" href="https://dev.status.im/es/research/ulc_in_details.html">
    
      <link rel="alternative" hreflang="ko" href="https://dev.status.im/ko/research/ulc_in_details.html">
    
  
  <!-- Icon -->
  <link rel="icon" type="image/png" href="/img/logo-16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/img/logo-32.png" sizes="32x32">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon-76.png?v=0.0.5">
  <link rel="apple-touch-icon" sizes="120x120" href="/img/apple-touch-icon-120.png?v=0.0.5">
  <link rel="apple-touch-icon" sizes="152x152" href="/img/apple-touch-icon-152.png?v=0.0.5">
  <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon-180.png?v=0.0.5">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon-1024.png?v=0.0.5">
  <link rel="stylesheet" href="/css/main.min.css">
  <link rel="alternate" href="/atom.xml" title="Status">
  <meta property="og:image" content="/img/share.png">
  <meta property="og:title" content="Status, a Mobile Client for Ethereum 2.0">
</head>

<body>
  <div id="container">
    
      <div class="header">
    <div class="header-left">
        <a class="logo" href="/"></a>
        
<ul class="main-nav">
    <li class="item--to-show"><a href="https://status.im/get" class="">App</a></li>
    <li class="item--to-show"> <a href="https://our.status.im/">Blog</a> </li>
    <li class="item--to-show"> <a href="https://status.im/docs">Docs</a></li>
    <li class="item--dropdown item--dropdown-projects"> <a href="#" class="">Projects</a></li>
    <li><a href="https://status.im/contribute">Contribute</a></li>
    <li class="item--dropdown"><a href="#" class="item--dropdown-community">Community</a></li>
    <li class="item--more"><a href="#" class="item--more">More</a></li>
</ul>

    </div>
    <div class="header-right">
        <a href="https://get.status.im/chat/public/status" class="button">Join Status Chat</a>
    </div>
</div>

<div class="mobile-nav-wrap">
    <div class="mobile-nav-inner">
        <a class="logo" href="/"></a>
        <a class="icon-close mobile-nav-close" href="#"></a>
        <ul class="mobile-nav">
            <li><a href="https://our.status.im/">Blog</a></li>
            <li><a href="/docs">Docs</a></li>
            <li class="item--dropdown item--to-show">
              <span>Projects</span>
              <ul class="mobile-sub-nav">
                <li><a href="https://incubate.status.im/" class="">Incubate</a></li>
                <li><a href="https://nimbus.status.im/" class="">Nimbus</a></li>
                <li><a href="https://embark.status.im/" class="">Embark</a></li>
                <li><a href="https://hardwallet.status.im/" class="">Keycard</a></li>
              </ul>
            </li>
            <li><a href="/contribute" class="">Contribute</a></li>
        </ul>
        <div class="mobile-nav-footer">
            <a href="https://get.status.im/chat/public/status" class="button button--blue">Join Status Chat</a>
        </div>
    </div>
    <div class="mobile-nav-overlay"></div>
</div>

<div class="popup-wrap popup-wrap--community">
    <div class="popup popup--community">
        <a class="popup__button popup__button--close"></a>
        <h3 class="popup__title">Community</h3>
        <div class="popup__inner">
            <div class="cards cards--three cards--three--even cards--community cards--community--light">
                <div class="card">
                    <a href="https://get.status.im/chat/public/status" class="card-inner">
                        <div class="community-icon community-icon--join"></div>
                        <h4>Join the chat in Status</h4>
                        <p class="secondary-text">Whisper sweet, encrypted nothings on a distributed network that no-one owns.</p>
                    </a>
                </div>
                <div class="card">
                    <a href="https://discuss.status.im/" class="card-inner">
                        <div class="community-icon community-icon--discussion"></div>
                        <h4>Join the Discussion</h4>
                        <p class="secondary-text">Join longer discussions, work in progress, and our research here.</p>
                    </a>
                </div>
                <div class="card">
                    <a href="https://github.com/status-im/" class="card-inner">
                        <div class="community-icon community-icon--contrubute"></div>
                        <h4>Contribute to our Repos</h4>
                        <p class="secondary-text">Help us #buidl the future by getting involved in the most active code base in Ethereum.</p>
                    </a>
                </div>
            </div>
            <h5>Find Out More</h5>
            <div class="cards cards-community-more cards--three cards--three--even">
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <div class="latest-posts latest-news"></div>
                        </div>
                        <div class="card-community-more__link"><a href="https://our.status.im/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Life at Status</h4>
                            <p class="secondary-text">What's it like to live the decentralized lifestyle? Find out here.</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://status.im/contribute/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Follow us on Twitter</h4>
                            <p class="secondary-text">Join the conversation on our social channels to learn more.</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://twitter.com/ethstatus/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="popup-overlay"></div>
</div>

<div class="popup-wrap popup-wrap--projects">
    <div class="popup popup--projects">
        <a class="popup__button popup__button--close"></a>
        <h3 class="popup__title">Projects</h3>
        <div class="popup__inner">
            <h5>Help us #buidl</h5>
            <div class="cards cards-community-more cards--three cards--three--even">
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Embark</h4>
                            <p class="secondary-text">Embark is a simple and easy to use development framework that enables you to build and deploy your own decentralized applications smoothly.</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://embark.status.im/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Nimbus</h4>
                            <p class="secondary-text">A research project and light client for Ethereum 2.0 designed to perform well on embedded systems and resource-restricted hardware.</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://nimbus.status.im" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Keycard</h4>
                            <p class="secondary-text">A hardware wallet in the form of a card with a safe, contactless transaction experience</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://hardwallet.status.im/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
            </div>
            <div class="separator"></div>
            <h5>Enable Everyone</h5>
            <div class="cards cards-community-more cards--three cards--three--even">
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Incubate</h4>
                            <p class="secondary-text">Incubate supports open source, early stage startups with funding, technical mentorship, legal and regulatory compliance and much more.</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://incubate.status.im/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-inner">
                        <div class="card-content">
                            <h4>Statusphere</h4>
                            <p class="secondary-text">Get involved in our community today, no matter who you are.</p>
                        </div>
                        <div class="card-community-more__link"><a href="https://status.im/statusphere/" class="link-arrow">Learn more</a></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="popup-overlay"></div>
</div>

    
    <div class="page-intro wrapper">
  <header class="article-header">
    <h1 class="article-title" itemprop="name">Ultra Light Client in details</h1>
    <a href="https://github.com/status-im/docs.status.im/edit/develop/source/research/ulc_in_details.md" class="article-edit-link" title="Improve this doc">Edit on Github</a>
  </header>
</div>
<div id="content-wrap">
  <div id="content" class="wrapper">
    <div id="content-inner">
      <aside id="sidebar" role="navigation">
  <div class="inner">
    <strong class="sidebar-title">Whisper</strong><a href="index.html" class="sidebar-link">Do You Want To Know A Secret?</a><a href="extended_features.html" class="sidebar-link">Extended Features</a><a href="dark_routing.html" class="sidebar-link">Dark Routing</a><a href="whisper_pss.html" class="sidebar-link">Comparison with PSS</a><a href="whisper_faqs.html" class="sidebar-link">Whisper FAQs</a><a href="secure_messaging_compendium.html" class="sidebar-link">Secure Messaging Compendium</a><a href="https://our.status.im/tag/research" class="sidebar-link">Research Blog</a><strong class="sidebar-title">Research Projects</strong><a href="ulc_in_details.html" class="sidebar-link current">Ultra Light Clients</a><a href="https://nimbus.status.im/" class="sidebar-link">Nimbus</a><strong class="sidebar-title">Tutorials</strong><a href="../tutorials/whisper_basic_cli.html" class="sidebar-link">Whisper in Your CLI</a><a href="../tutorials/whisper_embark.html" class="sidebar-link">Whisper with Embark</a>
  </div>
</aside>
      <article class="article-container" itemscope="" itemtype="http://schema.org/Article">
        <div class="article-inner">
          <div class="article">
            <div class="inner">
              <div class="article-content" itemprop="articleBody">
                <h1 id="Ultra-Light-Client-in-details" class="article-heading"><a href="#Ultra-Light-Client-in-details" class="headerlink" title="Ultra Light Client in details"></a>Ultra Light Client in details<a class="article-anchor" href="#Ultra-Light-Client-in-details" aria-hidden="true"></a></h1><h2 id="Definitions" class="article-heading"><a href="#Definitions" class="headerlink" title="Definitions"></a>Definitions<a class="article-anchor" href="#Definitions" aria-hidden="true"></a></h2><ul>
<li><strong>TD</strong> - the total difficulty of the chain until a given block</li>
<li><strong>LES</strong> - light Ethereum subprotocol</li>
<li><strong>ULC</strong> - ultra light client, an option of LES</li>
<li><strong>CHT</strong> - Canonical Hash Trie which maps historical block numbers to their canonical hashes in a Merkle trie. This allows us to discard the block headers themselves in favor of a trie root which encompasses the accumulation of their hashes, and to fetch proofs that a specific block hash is in fact the one we verified earlier <a href="https://wiki.parity.io/The-Parity-Light-Protocol-(PIP)" target="_blank" rel="noopener">[1]</a></li>
</ul>
<h2 id="Overview" class="article-heading"><a href="#Overview" class="headerlink" title="Overview"></a>Overview<a class="article-anchor" href="#Overview" aria-hidden="true"></a></h2><p>ULC is a new option in LES that doesn’t break compatibility with the LES protocol, but does significantly reduce the time and resources required to sync with the main Ethereum chain.</p>
<p>The main idea is to reduce the amount of messages and do less client side validation.</p>
<h2 id="What-does-ULC-solves" class="article-heading"><a href="#What-does-ULC-solves" class="headerlink" title="What does ULC solves?"></a>What does ULC solves?<a class="article-anchor" href="#What-does-ULC-solves" aria-hidden="true"></a></h2><p>1) CPU and battery consumption<br>2) Time to start sync<br>3) Time to finish sync</p>
<h2 id="ULC-in-schemes" class="article-heading"><a href="#ULC-in-schemes" class="headerlink" title="ULC in schemes"></a>ULC in schemes<a class="article-anchor" href="#ULC-in-schemes" aria-hidden="true"></a></h2><h3 id="Algorithm" class="article-heading"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm<a class="article-anchor" href="#Algorithm" aria-hidden="true"></a></h3><pre><code class="flow">st=&gt;start: Start LES client
with ULC options

op=&gt;operation: Connect to N Trusted LES servers
Hold these connections

op2=&gt;operation: Ask for signed announcements
for the block with max TD

op3=&gt;operation: Sync CHTs up to known max TD

op4=&gt;operation: Ask for N latest
signed announcements

op5=&gt;operation: Ask usual LES server (can be different each time)
for a block header

cond=&gt;condition: Are M of N announcements the same?
Are all signs valid?

st-&gt;op-&gt;op2-&gt;op3-&gt;op4-&gt;cond-&gt;op5-&gt;op4
cond(yes)-&gt;op5
cond(no)-&gt;op4
</code></pre>
<h3 id="Dataflow" class="article-heading"><a href="#Dataflow" class="headerlink" title="Dataflow"></a>Dataflow<a class="article-anchor" href="#Dataflow" aria-hidden="true"></a></h3><pre><code class="sequence">ULC-&gt;N_Trusted: handshake
Note right of N_Trusted: setup LES params
N_Trusted--&gt;ULC: handshake

Note left of ULC: CHT sync
ULC-&gt;N_Trusted: Ask to announce
N_Trusted--&gt;ULC: Highest announce
Note left of ULC: announce:\nblock hash, TD, number

ULC-&gt;N_Trusted: Ask CHTs
N_Trusted--&gt;ULC: CHT &quot;chain&quot; sync

Note left of ULC: Sync headers starting\nfrom latest block CHT + 1
ULC-&gt;N_Trusted: Ask to announce
N_Trusted--&gt;ULC: announce

ULC-&gt;Untrusted: handshake
Untrusted--&gt;ULC: handshake

ULC-&gt;Untrusted: ask block header
Untrusted--&gt;ULC: header
Note left of ULC: header:\nblock announce, logsBloom,\nMerkle trees roots:\nstate, transactions, receipts
</code></pre>
<h3 id="Validation-of-header-“chain”-for-LES-and-ULC" class="article-heading"><a href="#Validation-of-header-“chain”-for-LES-and-ULC" class="headerlink" title="Validation of header “chain” for LES and ULC"></a>Validation of header “chain” for LES and ULC<a class="article-anchor" href="#Validation-of-header-“chain”-for-LES-and-ULC" aria-hidden="true"></a></h3><ol>
<li>sanity check that the provided chain is actually ordered and linked. If we have a header chain of length N, for every <code>$n_i$</code> and <code>$n_{i-1}$</code>, <code>$i \epsilon [0; N]$</code>, conditions should hold:<ol>
<li><code>$n_i.Number = n_{i-1}.Number+1$</code></li>
<li><code>$n_i.ParentHash = n_{i-1}.Hash$</code></li>
</ol>
</li>
<li>in Ethereum Yellow Paper section 4.3.4. “Block Header Validity”<a href="https://ethereum.github.io/yellowpaper/paper.pdf" target="_blank" rel="noopener">[2]</a><ol>
<li>The length of <code>$n_i.Extra &lt; 32 bytes$</code></li>
<li>Checks block timestamp:<ol>
<li>It shouldn’t be from future more than 15 secs</li>
<li><code>$n_i.Time &gt; n_{i-1}.Time$</code></li>
</ol>
</li>
<li>verify the block’s difficulty based on its timestamp and parent block’s difficulty: <code>$n_i.Difficulty = expectedDifficulty(n_i)$</code></li>
<li><code>$n_i.gasLimit$</code> shouldn’t overflow <code>2^63-1</code></li>
<li><code>$n_i.gasUsed &lt;= n_i.gasLimit$</code></li>
<li>checks gas limit:<ol>
<li>should be more than MinGasLimit: <code>$n_i.gasLimit &gt;= 5000$</code></li>
<li>the change of $n_i$ gas should be bounded: <code>$|parent.GasLimit - header.GasLimit| &lt; parent.GasLimit / 1024$</code></li>
</ol>
</li>
<li>validate hard forks special fields, eg. every <code>$n_i \epsilon [DAOForkBlock; DAOForkBlock+10]$</code> should have special value in <code>ExtraData</code> field </li>
<li>Verify a seal securing the block</li>
</ol>
</li>
</ol>
<h4 id="Verify-a-seal-of-a-block" class="article-heading"><a href="#Verify-a-seal-of-a-block" class="headerlink" title="Verify a seal of a block"></a>Verify a seal of a block<a class="article-anchor" href="#Verify-a-seal-of-a-block" aria-hidden="true"></a></h4><p>The main difference in ULC is that a client doesn’t need to verify the seal of a block and can skip this step completely.</p>
<p>Ethereum <code>light</code> clients (actually <code>fast</code> and <code>light</code>) have slow-but-light PoW verification. <code>Full</code> clients have fast-but-heavy PoW verification. The main difference is that <code>full</code> clients generate all the data needed to verify every block in an epoch, but light clients calculate many values on-the-fly (see <code>$generateDatasetItem$</code> below on “Verify step”).</p>
<p>The detailed algorithm can be found on the <a href="https://github.com/ethereum/wiki/wiki/Ethash" target="_blank" rel="noopener">Ethereum wiki</a>.</p>
<p>The verification has 2 steps: init caches and verify. Let’s describe them in detail.</p>
<h5 id="Init-step" class="article-heading"><a href="#Init-step" class="headerlink" title="Init step"></a>Init step<a class="article-anchor" href="#Init-step" aria-hidden="true"></a></h5><ul>
<li><em>All numbers below are given for the Epoch 232 (a current epoch at 12 Nov 2018)</em></li>
<li><em>Some parts of this step can be run in parallel.</em></li>
<li><em>All numbers and the algorithm steps are from <a href="https://github.com/ethereum/go-ethereum/blob/master/consensus/ethash/consensus.go#L239" target="_blank" rel="noopener">geth code</a></em></li>
</ul>
<p>It runs once per epoch: <code>epochLength = 30000 blocks ~ each 3.5 days = twice per week</code></p>
<p>It needs to generate a verification matrix of pseudo-random values (called <code>cache</code>).</p>
<ol>
<li>Calculate seedHash in <code>epochNumber steps = 232 sha3 operations</code></li>
<li>Calculate the initial cache in:  <code>cacheSize/64 steps = 51641792/64 = 806900 sha3 operations</code>. </li>
<li><code>CacheSize</code> can be taken from <a href="https://github.com/ethereum/go-ethereum/blob/master/consensus/ethash/algorithm.go#L821" target="_blank" rel="noopener">table <code>cacheSizes</code></a>, for <code>epoch=232</code> it equals <code>51641792</code>.</li>
</ol>
<p>At the end of the day <code>$O_{cpu}(initStep)= N*O(sha3)$</code>, where <code>N</code> is a current block number.</p>
<p>For example, for epoch 232 (a current epoch at 12 Nov 2018) <code>$O_{cpu}(initStep) = O_{cpu}(seedHash)+O_{cpu}(initCahce) = 807133*O(sha3)$</code>.</p>
<p>This is the theoretical lower bound. The <a href="https://github.com/ethereum/wiki/wiki/Ethash-Design-Rationale" target="_blank" rel="noopener">Ethash Design Rationale</a> mentions that “a light client should become fully operational and be able to verify blocks within 40 seconds in Javascript”.</p>
<h5 id="Verify-step" class="article-heading"><a href="#Verify-step" class="headerlink" title="Verify step"></a>Verify step<a class="article-anchor" href="#Verify-step" aria-hidden="true"></a></h5><p>Light mode seal verification doesn’t store the entire dataset for block verification, but generates necessary items on-the-fly. For a single block it runs the <code>hashimotoLight</code> algorithm which takes:</p>
<p><code>$generateDatasetItem = (2*sha3 + 512*fnv)$</code></p>
<p>_More details about FNV32-1 hash function can be found <a href="https://en.wikipedia.org/wiki/Fowler%E2%80%93Noll%E2%80%93Vo_hash_function" target="_blank" rel="noopener">here</a>._</p>
<pre><code>$hashimotoLight = loopAccesses*mixBytes/hashBytes * (generateDatasetItem + fnvHash)$
$hashimotoLight = 64*128/64 *(generateDatasetItem + fnv)$
$hashimotoLight = 128*(generateDatasetItem + fnv)$
$hashimotoLight = 256 sha3 + 65664 fnv$
</code></pre><p>This is the difference between ULC and LES clients for each block. Because the CHT is generated once per 32767 blocks, the total difference is <code>$[1; 32767] * Cost(hashimotoLight) = [256*O(sha3) + 65664*O(fnv) ; 8.388.352*O(sha3) + 2.151.612.288*O(fnv)]$</code>. The growth is linear.</p>
<p>This is the theoretical lower bound. As noted in the <a href="https://github.com/ethereum/wiki/wiki/Ethash-Design-Rationale" target="_blank" rel="noopener">Ethash Design Rationale</a>, a single block verification step should take <code>&#39;0.1 seconds in Python&#39;</code>. In practice it takes <code>~200ms</code> in Geth.</p>
<h2 id="LES-vs-ULC" class="article-heading"><a href="#LES-vs-ULC" class="headerlink" title="LES vs ULC"></a>LES vs ULC<a class="article-anchor" href="#LES-vs-ULC" aria-hidden="true"></a></h2><p>So ULC saves <code>807133*O(sha3)</code> at init stage, which happens each epoch, and [<code>256*O(sha3) + 65664*O(fnv) ; 8.388.352*O(sha3) + 2.151.612.288*O(fnv)]</code> for each block while syncing. Because the difficulty of block verification grows linearly, the total difficulty of syncing <code>N</code> blocks grows as <code>$N^2$</code>.</p>
<h2 id="ULC-in-Roles" class="article-heading"><a href="#ULC-in-Roles" class="headerlink" title="ULC in Roles"></a>ULC in Roles<a class="article-anchor" href="#ULC-in-Roles" aria-hidden="true"></a></h2><h3 id="Trusted-LES-servers" class="article-heading"><a href="#Trusted-LES-servers" class="headerlink" title="Trusted LES servers"></a>Trusted LES servers<a class="article-anchor" href="#Trusted-LES-servers" aria-hidden="true"></a></h3><p>Trusted LES servers are needed only to send announcements (in Geth code it has the name <code>announce(block hash, TD, number)</code>) to LES(ULC) clients. All announcements should be signed. Trusted servers don’t know whether they have been chosen as trusted or not by any given client. Such servers can be started with an <code>onlyAnnounce</code> flag, which ensures that the LES server operates under the rule “only send announcements to my peers, do not process any other requests”.</p>
<h3 id="LES-servers-untrusted" class="article-heading"><a href="#LES-servers-untrusted" class="headerlink" title="LES servers (untrusted)"></a>LES servers (untrusted)<a class="article-anchor" href="#LES-servers-untrusted" aria-hidden="true"></a></h3><p>LES servers - usual LES servers, a header chain is synchronised with them. Helps to prevent attacks on trusted servers.</p>
<h3 id="ULC-client" class="article-heading"><a href="#ULC-client" class="headerlink" title="ULC client"></a>ULC client<a class="article-anchor" href="#ULC-client" aria-hidden="true"></a></h3><ol>
<li>has some CHT root at the start; has a CHTs “chain” that can be synced from LES servers; CHT chain allows to request any historical information (block, transaction, receipt) from LES server.</li>
<li>trusts announcements received from <code>N</code> Trusted LES servers. Announcements should be signed by Trusted LES servers. There should be at least <code>M</code> identical announcements to trust.</li>
<li>Asks for announcements with the biggest TD.</li>
<li>ULC client starts CHT sync before syncing header chain. ULC client requests newer CHTs from LES servers.</li>
<li>requests headers from untrusted LES server, starting from <code>the highest block is known to latest CHT + 1</code> up to latest block number known from the last trusted announcement.</li>
<li><p>ULC client validates:</p>
<ol>
<li><p>announcements, checking if there are <code>M</code> of the same announcements as the <code>N</code> received from Trusted LES servers.    </p>
</li>
<li><p>headers, as usual, LES client except <a href="https://github.com/ethereum/go-ethereum/blob/master/consensus/ethash/consensus.go#L491" target="_blank" rel="noopener">VerifySeal</a>. ULC doesn’t run <code>VerifySeal</code> at all.</p>
</li>
</ol>
</li>
<li><p>ULC servers don’t validate the CHT. If we get and incorrect CHT, it’ll be clear later after receiving the block headers.</p>
</li>
</ol>
<h2 id="ULC-client-resources" class="article-heading"><a href="#ULC-client-resources" class="headerlink" title="ULC client resources"></a>ULC client resources<a class="article-anchor" href="#ULC-client-resources" aria-hidden="true"></a></h2><h3 id="Network" class="article-heading"><a href="#Network" class="headerlink" title="Network"></a>Network<a class="article-anchor" href="#Network" aria-hidden="true"></a></h3><ul>
<li>CHT is received from a single LES server that is considered “best to sync” at the moment</li>
<li>headers are received from a single LES server</li>
<li>announcements are received from <code>N</code> Trusted LES servers</li>
</ul>
<h3 id="Network-connections" class="article-heading"><a href="#Network-connections" class="headerlink" title="Network connections"></a>Network connections<a class="article-anchor" href="#Network-connections" aria-hidden="true"></a></h3><ul>
<li>tries to be always connected to <code>N</code> Trusted LES servers, in case of disconnection it reconnects</li>
<li>handles a usual number of connections to LES servers</li>
</ul>
<h3 id="Storage" class="article-heading"><a href="#Storage" class="headerlink" title="Storage"></a>Storage<a class="article-anchor" href="#Storage" aria-hidden="true"></a></h3><ul>
<li>at least one CHT, but we can have several consecutive CHTs</li>
<li>headers chain of blocks of the latest Epoch</li>
</ul>
<h2 id="Security" class="article-heading"><a href="#Security" class="headerlink" title="Security"></a>Security<a class="article-anchor" href="#Security" aria-hidden="true"></a></h2><h3 id="Main-issues" class="article-heading"><a href="#Main-issues" class="headerlink" title="Main issues"></a>Main issues<a class="article-anchor" href="#Main-issues" aria-hidden="true"></a></h3><p>1) Most are inherited from LES<br>2) Too few LES servers in the Network<br>3) Trusted servers discovery (?)<br>4) DoS on trusted nodes</p>
<h3 id="Sybill-attack-on-ULC-client" class="article-heading"><a href="#Sybill-attack-on-ULC-client" class="headerlink" title="Sybill attack on ULC (client)"></a>Sybill attack on ULC (client)<a class="article-anchor" href="#Sybill-attack-on-ULC-client" aria-hidden="true"></a></h3><p>Prevented because it is already prevented in a classic LES model and we only download headers with trusted announcements.</p>
<h3 id="Sybill-attack-on-trusted-servers" class="article-heading"><a href="#Sybill-attack-on-trusted-servers" class="headerlink" title="Sybill attack on trusted servers"></a>Sybill attack on trusted servers<a class="article-anchor" href="#Sybill-attack-on-trusted-servers" aria-hidden="true"></a></h3><p>Even less possible than in LES model because you’d need to attack at least <code>M</code> servers.</p>
<h3 id="DoS-on-trusted-servers" class="article-heading"><a href="#DoS-on-trusted-servers" class="headerlink" title="DoS on trusted servers"></a>DoS on trusted servers<a class="article-anchor" href="#DoS-on-trusted-servers" aria-hidden="true"></a></h3><p>Possible. ULC makes it much less possible by hiding what nodes are trusted for each user. A user doesn’t send anything unusual for LES to trusted or untrusted servers. Any “trusted for a user” LES server doesn’t know that it has been chosen by the user to be a trusted LES server.</p>
<h3 id="MITM" class="article-heading"><a href="#MITM" class="headerlink" title="MITM"></a>MITM<a class="article-anchor" href="#MITM" aria-hidden="true"></a></h3><p>Prevented because all announcements must be signed by according LES server.</p>
<h3 id="What-other-security-guarantees-does-ULC-give-and-what-is-it-comparable-with" class="article-heading"><a href="#What-other-security-guarantees-does-ULC-give-and-what-is-it-comparable-with" class="headerlink" title="What other security guarantees does ULC give and what is it comparable with?"></a>What other security guarantees does ULC give and what is it comparable with?<a class="article-anchor" href="#What-other-security-guarantees-does-ULC-give-and-what-is-it-comparable-with" aria-hidden="true"></a></h3><h4 id="Some-math" class="article-heading"><a href="#Some-math" class="headerlink" title="Some math"></a>Some math<a class="article-anchor" href="#Some-math" aria-hidden="true"></a></h4><p>There’re 2 kinds of security guarantees:</p>
<ol>
<li>reducing the probability of failure to perform a correct request due to the failure of remote servers - failure and censorship resistance</li>
<li>reducing the need to trust data coming in from potentially malicious nodes</li>
</ol>
<p>The way ULC handles blockchain synchronisation is the same as LES. Therefore, comparing the security guarantees of ULC with full, fast and LES does not make sense. It is more important to compare the guarantees of a private RPC server or Infura with ULC.</p>
<p>If the probability of failure, or hacking Infura or RPC server is taken as <code>P</code> then, with the ULC consensus <code>M/N</code> trusted LES nodes, the probability of its failure can be considered as Bernoulli process:</p>
<p><code>$$P_{ULC\_failure}=\sum_{i=M}^N C_N^i*P^i*(1-P)^{N-i}$$</code></p>
<p><em>*Failure</em> - in the sense of Byzantine Failure, i.e. either a node crash or some malicious action. Such a failure for a trusted LES node would be sending fake announcements in an attempt to “switch” a user to a malicious chain.</p>
<p>For example, let’s calculate the failure probability <code>$P_{ULC\_failure}$</code> while syncing or getting an incorrect state, given <code>N=10</code>, <code>M=6</code> and the failure probability of a single node P:</p>
<pre><code>$$P_{ULC\_failure}=C_{10}^6*P^6*(1-P)^4+C_{10}^7*P^7*(1-P)^3+C_{10}^8*P^8*(1-P)^2
+C_{10}^9*P^9*(1-P)+C_{10}^{10}*P^{10}$$
</code></pre><pre><code>$$P_{ULC\_failure}=210*(1 - P)^4*P^6 + 120*(1 - P)^3*P^7 + 45*(1 - P)^2*P^8 
+ 10*(1 - P)*P^9 + P^{10}$$
</code></pre><p>Let’s take several values of the LES server failure probability and see what the probability of ULC breakage of the client is:</p>
<table>
<thead>
<tr>
<th>$P_{server_failure}$</th>
<th>5%</th>
<th>1%</th>
<th>0.1%</th>
<th>0.01%</th>
</tr>
</thead>
<tbody>
<tr>
<td>~$P_{ULC_failure}$</td>
<td>$10^{-6}\%$</td>
<td>$10^{-10}\%$</td>
<td>$10^{-16}\%$</td>
<td>$10^{-22}\%$</td>
</tr>
</tbody>
</table>
<p><img src="https://i.imgur.com/D8lh6eG.png" alt="0-1"></p>
<p><img src="https://i.imgur.com/0GmOWvy.png" alt="0-0.001"></p>
<p>So ULC drastically increases the censorship resistance of an Ethereum client. We can develop a far more reliable system using unreliable nodes.</p>
<p>A few N/M, given $P_{server_failure}=0.01\%$:</p>
<table>
<thead>
<tr>
<th>N</th>
<th>M</th>
<th>~$P_{ULC_failure}$</th>
</tr>
</thead>
<tbody>
<tr>
<td>3</td>
<td>2</td>
<td>$3*10^{-8}\%$</td>
</tr>
<tr>
<td>4</td>
<td>2</td>
<td>$6*10^{-8}\%$</td>
</tr>
<tr>
<td>4</td>
<td>3</td>
<td>$4*10^{-12}\%$</td>
</tr>
<tr>
<td>5</td>
<td>2</td>
<td>$10^{-7}\%$</td>
</tr>
<tr>
<td>5</td>
<td>3</td>
<td>$10^{-11}\%$</td>
</tr>
<tr>
<td>5</td>
<td>4</td>
<td>$5*10^{-16}\%$</td>
</tr>
<tr>
<td>6</td>
<td>2</td>
<td>$1.5*10^{-7}\%$</td>
</tr>
<tr>
<td>6</td>
<td>3</td>
<td>$2*10^{-11}\%$</td>
</tr>
<tr>
<td>6</td>
<td>4</td>
<td>$1.5*10^{-15}\%$</td>
</tr>
<tr>
<td>6</td>
<td>5</td>
<td>$6*10^{-20}\%$</td>
</tr>
</tbody>
</table>
<p>Values 2/3, 3/4, 3/5, 4/5 look like reasonable values to use in ULC client.</p>
<table>
<thead>
<tr>
<th>N</th>
<th>M</th>
<th>~$P_{ULC_failure}$</th>
</tr>
</thead>
<tbody>
<tr>
<td>3</td>
<td>1</td>
<td>$3*10^{-8}\%$</td>
</tr>
<tr>
<td>4</td>
<td>1</td>
<td>$6*10^{-8}\%$</td>
</tr>
<tr>
<td>5</td>
<td>1</td>
<td>$10^{-7}\%$</td>
</tr>
<tr>
<td>5</td>
<td>2</td>
<td>$10^{-11}\%$</td>
</tr>
<tr>
<td>6</td>
<td>1</td>
<td>$1.5*10^{-7}\%$</td>
</tr>
<tr>
<td>6</td>
<td>2</td>
<td>$2*10^{-11}\%$</td>
</tr>
</tbody>
</table>
<h4 id="Trusted-nodes" class="article-heading"><a href="#Trusted-nodes" class="headerlink" title="Trusted nodes"></a>Trusted nodes<a class="article-anchor" href="#Trusted-nodes" aria-hidden="true"></a></h4><p>ULC clients need a set of trusted LES servers to get the current Chain state. It should be said that only ULC clients knows their own <code>trusted list</code>, LES servers don’t know whether they’ve been chosen as trusted by some ULC client. The key difference is that ULC clients request and accept only the signed announcements needed to trust some nonce (PoW) without performing their own check.</p>
<p>We’re going to provide, predefined in the App, a trusted LES servers list. This also means that an application wanting to use ULC can define their own such trusted list of clients and do load balancing with a simple random choice.</p>
<p>One of the major drawbacks currently, however, is that LES servers can handle only a limited number of clients. At the moment it’s $LES_limit=25$.</p>
<p>So if we want 3(M) out of 4(N) ULC consensus, in average we have 1000 users online, so we need minimum $Servers=Max(AverageUsers<em>N/LES_limit; N)=Max(1000</em>4/25; 4)=160$</p>
<p>It is for this reason that a new option was added in ULC for LES servers: <code>--onlyAnnounce</code>. This flag ensures LES servers only handle <code>get announce</code> requests, which increases the possible number of simultaneous users to about ~250 (should be stress tested).</p>
<p>With <code>--onlyAnnounce</code> the formula looks like:<br>$Servers=Max(AverageUsers<em>N/LES_only_announce_limit; N)=Max(1000</em>4/250; 4)=Max(16; 4)=16$</p>
<table>
<thead>
<tr>
<th>Users online</th>
<th>N</th>
<th>Server w/o <code>onlyAnnounce</code></th>
<th>With <code>onlyAnnounce</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>1000</td>
<td>4</td>
<td>160</td>
<td>16</td>
</tr>
<tr>
<td>1000</td>
<td>5</td>
<td>200</td>
<td>20</td>
</tr>
<tr>
<td>1000</td>
<td>6</td>
<td>240</td>
<td>24</td>
</tr>
<tr>
<td>1000</td>
<td>7</td>
<td>280</td>
<td>28</td>
</tr>
<tr>
<td>5000</td>
<td>4</td>
<td>800</td>
<td>80</td>
</tr>
<tr>
<td>5000</td>
<td>5</td>
<td>1000</td>
<td>100</td>
</tr>
<tr>
<td>5000</td>
<td>6</td>
<td>1200</td>
<td>120</td>
</tr>
<tr>
<td>5000</td>
<td>7</td>
<td>1400</td>
<td>140</td>
</tr>
<tr>
<td>10000</td>
<td>4</td>
<td>1600</td>
<td>160</td>
</tr>
<tr>
<td>10000</td>
<td>5</td>
<td>2000</td>
<td>200</td>
</tr>
<tr>
<td>10000</td>
<td>6</td>
<td>2400</td>
<td>240</td>
</tr>
<tr>
<td>10000</td>
<td>7</td>
<td>2800</td>
<td>280</td>
</tr>
</tbody>
</table>
<p>It’s obvious that scaling due to server expansion inside the service is strictly limited. A prerequisite for the operation of ULC at large scales is an increase in the percentage of LES of servers relative to all Ethereum servers.</p>
<p>At the moment there are 15000 nodes. If 30% of them would use the LES server option, more than 300 000 ULC users could be handled simultaneously.</p>
<h2 id="Benchmarks" class="article-heading"><a href="#Benchmarks" class="headerlink" title="Benchmarks"></a>Benchmarks<a class="article-anchor" href="#Benchmarks" aria-hidden="true"></a></h2><p>Our beta test showed that ULC sync is ~10x times <a href="https://youtu.be/Z6UUT1TqdTs?t=623" target="_blank" rel="noopener">faster than LES</a></p>
<h2 id="Plans" class="article-heading"><a href="#Plans" class="headerlink" title="Plans"></a>Plans<a class="article-anchor" href="#Plans" aria-hidden="true"></a></h2><h3 id="Short-Term" class="article-heading"><a href="#Short-Term" class="headerlink" title="Short-Term"></a>Short-Term<a class="article-anchor" href="#Short-Term" aria-hidden="true"></a></h3><p>Status.im is going to start using ULC to achieve greater censorship resistance and enable all possible <code>web3</code> features for DApps and developers.</p>
<h3 id="Long-Term" class="article-heading"><a href="#Long-Term" class="headerlink" title="Long-Term"></a>Long-Term<a class="article-anchor" href="#Long-Term" aria-hidden="true"></a></h3><ul>
<li><a href="https://hackmd.io/6IhsF6zRSqmtggvNnp1sHQ" target="_blank" rel="noopener">On ULC incentives</a></li>
<li>Ethereum services are going to have microtransactions and this will make possible to create a market of LES server quotas using the proposed <a href="https://github.com/zsfelfoldi/ethereum-docs/blob/master/les/service_model.md#continous-auction" target="_blank" rel="noopener">LES service model</a></li>
</ul>

              </div>
              <footer class="article-footer">
                <time class="article-footer-updated" datetime="2018-12-07T09:15:09.526Z" itemprop="dateModified">Last updated: 2018-12-07</time>
                <a href="https://our.status.im/tag/research" class="article-footer-prev" title="Research Blog"><i class="fa fa-chevron-left"></i><span>Prev</span></a><a href="https://nimbus.status.im/" class="article-footer-next" title="Nimbus"><span>Next</span><i class="fa fa-chevron-right"></i></a>
              </footer>
            </div>
          </div>
        </div>
      </article>
    </div>
  </div>
</div>

    
      
<div class="footer footer--global">
    <div class="footer-inner">
        <div class="footer-table">
            <div class="footer-table__column">
                <p class="footer-header">Social links</p>
                <ul class="footer-list">
                    <li class="footer-link footer-link--fb"><a href="https://www.facebook.com/ethstatus" target="_blank"><span class="footer-icon"></span><span class="footer-link-label">Facebook</span></a></li>
                    <li class="footer-link footer-link--tw"><a href="https://twitter.com/ethstatus" target="_blank"><span class="footer-icon"></span><span class="footer-link-label">Twitter</span></a></li>
                    <li class="footer-link footer-link--ri"><a href="https://chat.status.im/#/register" target="_blank"><span class="footer-icon"></span><span class="footer-link-label">Riot</span></a></li>
                    <li class="footer-link footer-link--gh"><a href="https://github.com/status-im" target="_blank"><span class="footer-icon"></span><span class="footer-link-label">Github</span></a></li>
                    <li class="footer-link footer-link--rd"><a href="https://www.reddit.com/r/statusim/" target="_blank"><span class="footer-icon"></span><span class="footer-link-label">Reddit</span></a></li>
                    <li class="footer-link footer-link--yt"><a href="https://www.youtube.com/statusim" target="_blank"><span class="footer-icon"></span><span class="footer-link-label">YouTube</span></a></li>
                </ul>
            </div>

            <div class="footer-table__column">
                <p class="footer-header">More</p>
                <ul class="footer-list">
                    <li class="footer-link"><a href="https://status.im/docs/" target="_blank">Status Docs</a></li>
                    <li class="footer-link"><a href="https://our.status.im/" target="_blank">Status Blog</a></li>
                    <li class="footer-link"><a href="https://status.im/contribute/" target="_blank">Jobs</a></li>
                    <li class="footer-link"><a href="https://status.im/privacy-policy.html" target="_blank">Privacy Policy</a></li>
                </ul>
            </div>

            <div class="footer-table__column">
                <p class="footer-header">Projects</p>
                <ul class="footer-list">
                    <li class="footer-link"><a href="https://embark.status.im" target="_blank">Embark</a></li>
                    <li class="footer-link"><a href="https://hardwallet.status.im/" target="_blank">Keycard</a></li>
                    <li class="footer-link"><a href="https://incubate.status.im/" target="_blank">Incubate</a></li>
                    <li class="footer-link"><a href="https://nimbus.status.im/" target="_blank">Nimbus</a></li>
                </ul>
            </div>
        </div>
    
        <div class="footer-logo-wrap">
            <div class="footer-logo-wrap__inner">
                <a class="footer-logo" href="https://status.im" target="_blank"></a>
                <div class="footer-address secondary-text">Status Research & Development GmbH<br>Baarerstrasse 10<br>Zug, Switzerland</div>
            </div>
        </div>
    </div>
</div>

    
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>	
<script src="/js/vendor.min.js"></script>
</body>
</html>
